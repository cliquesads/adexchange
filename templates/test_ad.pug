doctype html
html(lang="en")
    head
        title="Cliques Ad Test"
        link(rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/5.9.6/jsoneditor.min.css")
        script(type='text/javascript' src="https://cdnjs.cloudflare.com/ajax/libs/jsoneditor/5.9.6/jsoneditor.min.js")
        style(type='text/css').
            body {
                font-family: 'Avenir',sans-serif;
            }
            #container {
                max-width: 100%;
                margin-left: 10px;
            }
            #ad2 {
                display: inline-block;
                width: 75%;
                left: 12.5%;
                position: relative;
            }
            h1 {
                left: 12.5%;
                width: 75%;
                position: relative;
            }
            .editorCol {
                width: 23%;
                float: left;
                margin: 10px;
            }
            .colWrapper {
                width: 100%
            }

    body
        #scripts
            script(type='text/javascript').
                window.smarter = function (key, options) {
                    setTimeout(function () {
                        options.handler({
                            ads: null,
                            destinationId: 191,
                            phgAdrefId: '1100l356s',
                            phgCamrefId: '1100l356s',
                            searchId: 189320
                        });
                    }, 300)
                };
                window.smarter.nativeActive = true;
            script(type='text/javascript').
                /*@preserve Cliques Ad Loader v0.9.33, built Thu Aug 02 2018 00:25:01 GMT-0400 (EDT) */
                var CLoader = CLoader || (function () {
                    var IMAGE_ATTR = 'data-cliquesnative';
                    var CLICK_ATTR = 'data-cliquesnative-click';

                    var _copyAttributes = function (oldNode, newNode) {
                        for (var i = 0; i < oldNode.attributes.length; i++) {
                            var attr = oldNode.attributes[i];
                            newNode.setAttribute(attr.name, attr.value);
                        }
                    };

                    var _replaceTemplateVar = function (template, varName, value) {
                        var re = new RegExp('{{(\\s|)' + varName + '(\\s|)}}', 'g');
                        // calling just template.replace will not properly replace full value if
                        // value includes any dollar signs, which are special characters for replace function.
                        // So have to wrap it in closure & pass it a predicate (I don't really know why)
                        var replaceString = function replaceString(replaceValue) {
                            return template.replace(re, function () {
                                return replaceValue
                            });
                        };
                        return replaceString(value);
                    };

                    var _addAttributeToTemplateVarElement = function (template, varName, attributeTitle) {
                        var re = new RegExp('({{[\\s|]' + varName + '[\\s|]}}[\\s\\S]*?)(>)', 'g');
                        return template.replace(re, '$1 ' + attributeTitle + '$2');
                    };

                    var _findChildrenWithAttribute = function (element, attribute) {
                        var c = [];
                        var _inner = function (element, attribute) {
                            if (element.childElementCount) {
                                for (var i = 0; i < element.children.length; i++) {
                                    var child = element.children[i];
                                    if (child.hasAttribute(attribute)) {
                                        c.push(child);
                                    }
                                    _inner(child, attribute);
                                }
                            }
                        };
                        _inner(element, attribute);
                        return c;
                    };

                    var _getTransformUrlFromCanonical = function (canonicalUrl, width, height, cloudinary) {
                        // check if browser supports devicePixelRatio prop, if so, scale image w & h by that
                        if (window.devicePixelRatio) {
                            height = Math.round(window.devicePixelRatio * height);
                            width = Math.round(window.devicePixelRatio * width);
                        }
                        var crop, gravity;
                        if (cloudinary) {
                            crop = cloudinary.crop || 'c_thumb';
                            gravity = cloudinary.gravity || 'g_auto';
                        }
                        var transform = [crop, gravity, 'h_' + height, 'w_' + width].join(',');
                        return canonicalUrl.replace(/(image\/upload\/)(.*$)/g, "$1" + transform + "/$2");
                    };

                    /**
                     * Forms click tracking URL from external parameters & _clickTracking private object
                     * @param context
                     * @private
                     */
                    var _getClickTrackingUrl = function (context) {
                        var url = context._clickTracking.trackingUrlBase;

                        // add external parameters, which are passed in tag config
                        if (context.external) {
                            url += '?' + serializeObject(context.external);
                        }

                        // now add auction data
                        // exchange will filter returned object based on auctionDataFields, but as of now this param
                        // won't get passed to adServer for various, probably-not-that-legit reasons, so for good measure
                        // will just construct new object with only requested fields from exchangeAuctionData & adserverAuctionData
                        if (context.auctionDataFields) {
                            var auctionData = {};
                            var fields = context.auctionDataFields.split(',');
                            fields.forEach(function (field) {
                                // fields in each auctionData object are assumed to be collision-proof,
                                // since each backend only sets specific parameters for auctionData.
                                if (context.exchangeAuctionData.hasOwnProperty(field)) {
                                    auctionData[field] = context.exchangeAuctionData[field];
                                } else if (context.adserverAuctionData.hasOwnProperty(field)) {
                                    auctionData[field] = context.adserverAuctionData[field];
                                }
                            });
                            url += (context.external ? '&' : '?') + serializeObject(auctionData);
                        }

                        if (context.creativeExternalId && context._clickTracking.creativeExternalIdKey) {
                            url = [url, [context._clickTracking.creativeExternalIdKey, context.creativeExternalId].join('=')].join('&');
                        }

                        if (context.campaignExternalId && context._clickTracking.campaignExternalIdKey) {
                            url = [url, [context._clickTracking.campaignExternalIdKey, context.campaignExternalId].join('=')].join('&');
                        }
                        return encodeURI(url);
                    };

                    /**
                     * Post-render steps for native ads. Primary purpose is to determine the size
                     * that the image needs to be based on DOM introspection, and then call the appropriate
                     * transform URL & replace image source as necessary within native template.
                     *
                     * @param targetElement
                     * @param context
                     * @param dims
                     * @private
                     */
                    var _templatePostRender = function (targetElement, context, dims) {

                        // first, un-wrap element and re-insert template where <ins> was
                        // this shouldn't re-render any remote sources, just move the DOM elements into the right placeholder
                        var parent = targetElement.parentElement;
                        var newTargets = [];
                        var childrenLength = targetElement.children.length;
                        for (var j = 0; j < childrenLength; j++) {
                            // node.insertBefore pops the element from the children array,
                            // so just push the 0th element for each j
                            newTargets.push(parent.insertBefore(targetElement.children[0], targetElement));
                        }
                        parent.removeChild(targetElement);

                        // find image element and set source to native image
                        // check all elements that were added to DOM
                        var images;
                        for (var i = 0; i < newTargets.length; i++) {
                            images = _findChildrenWithAttribute(newTargets[i], IMAGE_ATTR);
                            if (images.length > 0) {
                                break;
                            }
                        }
                        if (images.length === 0) {
                            console.error('Error: no image template tag found in template.');
                            return;
                        }
                        images.forEach(function (image) {
                            if (!dims) {
                                // this is a 2000x2000px blank PNG image.
                                var img = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAB9AAAAfQCAYAAACaOMR5AAABG2lUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4KPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iWE1QIENvcmUgNS41LjAiPgogPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIi8+CiA8L3JkZjpSREY+CjwveDp4bXBtZXRhPgo8P3hwYWNrZXQgZW5kPSJyIj8+Gkqr6gAAAYFpQ0NQc1JHQiBJRUM2MTk2Ni0yLjEAACiRdZHPK0RRFMc/ZmhkiGJhMYtJw8rIjxIbZSahJmmMMti8efNLzZt5vTeSbJWtosTGrwV/AVtlrRSRkrKzJjboOW+emknm3u45n/u955zuPRdcsZyqmbW9oOWLRnQ85J+Lz/s9z3jx0Sq2T1FNfXR6OkLV8XFHje1vgnat6nH/Dm8yZapQUy88oupGUXhCOLJS1G3eFm5Ts0pS+FS425ALCt/aesLhF5szDn/ZbMSiYXC1CPszFZyoYDVraMLycgJabln9vY/9ksZUfnZGfIcsHyZRxgnhZ5IxwgzSx7DYQYL00yM7quT3lvKnKEiuKlZnFYMlMmQp0i3qslRPiU+LnpKZY9Xu/9++mumBfqd6YwjqnizrrRM8W/C9aVmfh5b1fQTuR7jIl/MLBzD0LvpmWQvsQ/M6nF2WtcQOnG9A+4OuGEpJcstypdPwegJNcWi9hoYFp2e/5xzfQ2xNvuoKdvegS+KbF38AcHdn6m7T8mgAAAAJcEhZcwAAFiUAABYlAUlSJPAAACAASURBVHic7MEBAQAAAICQ/q/uCAoAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIDZgwMBAAAAACD/10ZQVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVJuz5TQAAHM5JREFUVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVYQ8OBAAAAACA/F8bQVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVaU9OCQAAAAAEPT/tSOsAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAwBU6HAABVjIW1QAAAABJRU5ErkJggg==';
                                image.src = img;
                            }
                            window.setTimeout(function () {
                                var h = dims ? dims.height : image.clientHeight;
                                var w = dims ? dims.width : image.clientWidth;
                                if (context.minImageHeight) {
                                    h = Math.max(h, context.minImageHeight);
                                }
                                if (context.minImageWidth) {
                                    w = Math.max(w, context.minImageWidth);
                                }
                                image.src = _getTransformUrlFromCanonical(context.secureImageUrl, w, h, context.cloudinary);
                            });
                        });

                        // now handle click event listeners
                        if (context._clickTracking) {
                            var clickTrackingUrl = _getClickTrackingUrl(context);
                            for (var k = 0; k < newTargets.length; k++) {
                                var clickElements = _findChildrenWithAttribute(newTargets[k], CLICK_ATTR);
                                if (clickElements.length > 0) {
                                    clickElements.forEach(function (el) {
                                        el.addEventListener('click', function () {
                                            var i = document.createElement('img');
                                            i.setAttribute('src', clickTrackingUrl);
                                            i.setAttribute('height', '1');
                                            i.setAttribute('width', '1');
                                            i.setAttribute('style', 'display: none;');
                                            el.append(i);
                                        }, true); // set to true to execute before click event is executed & page is redirected
                                    });
                                }
                            }
                        }
                    };

                    /**
                     * Script tags written to DOM (i.e. passback tags) will not execute, so this
                     * function re-inserts all script tags within a given element so they can be
                     * properly executed.
                     *
                     * @param parent
                     * @private
                     */
                    var _replaceScripts = function (parent) {
                        for (var j = 0; j < parent.children.length; j++) {
                            var thisNode = parent.children[j];
                            if (thisNode.nodeName === 'SCRIPT') {
                                if (thisNode.attributes.src) {
                                    var nextSibling = thisNode.nextSibling;
                                    parent.removeChild(thisNode);
                                    // now create new element
                                    var new_s = document.createElement("script");
                                    _copyAttributes(thisNode, new_s);
                                    parent.insertBefore(new_s, nextSibling);
                                } else {
                                    (new Function(thisNode.innerText))();
                                }
                            }
                            if (thisNode.children.length > 0) {
                                _replaceScripts(thisNode);
                            }
                        }
                    };

                    /**
                     * Helper function to check browser userAgent string and determine if browser is mobile browser or not
                     * based on regex. Regex should be updated periodically.
                     *
                     * Regex was copied from open source scripts available at [http://detectmobilebrowsers.com/]
                     *
                     * @returns {boolean}
                     */
                    var _isMobile = function () {
                        var check = false;
                        (function (a) {
                            if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true;
                        })(navigator.userAgent || navigator.vendor || window.opera);
                        return check;
                    };

                    /**
                     * Serializes object to query string
                     * @param obj
                     * @returns {string}
                     */
                    var serializeObject = function (obj) {
                        var str = [];
                        for (var p in obj)
                            if (obj.hasOwnProperty(p)) {
                                str.push(encodeURIComponent(p) + "=" + encodeURIComponent(obj[p]));
                            }
                        return str.join("&");
                    };

                    var _Loader = function (options) {
                        // to be populated by build scripts & outer constructors
                        this.exchange_hostname = 'localhost:5000';
                        this.exchange_secure_hostname = 'localhost:3000';
                        this.pub_path = '/pub';

                        // basic options
                        this.pid = options.pid;
                        this.secure = options.secure;
                        this.type = options.type || 'display';
                        this.debug = options.debug;

                        // determine formFactor right upfront
                        this.formFactor = _isMobile() ? 'mobile' : 'desktop';

                        // deeper template options, including placeholder objects for native & display specifics
                        this.native = {};
                        this.display = {};
                        this.multiPaneNative = {};
                        // placeholder for auctionData object, which will contain requested fields from winning bid objects
                        // & various identifiers
                        this.auctionData = null;


                        this.keywords = options.keywords || false;
                        this.events = options.events || {};

                        // if targetId && targetChildIndex are set, will override 'lazy' flag behavior,
                        // i.e. main() will render ad in target elements.
                        this.targetId = options.targetId;
                        this.targetChildIndex = options.targetChildIndex;
                        this.dynamicInsertion = (this.targetId && this.targetChildIndex);

                        // External, publisher specific ID's options to pass to exchange URL, which in turn
                        // get passed to adserver URLs
                        this.external = options.external;

                        // CSV list of fields containing auction-level data to pass to external click trackers
                        this.auctionDataFields = options.auctionDataFields;

                        // clickTracking subObj with base URL and key mapping for creative.externalID.
                        // If passed through (typically set by a factory), will add click event listeners
                        // to native ad `clickUrl` template element and serialize all `options.external` params
                        // as query parameters, and add to _clickTracking.trackingUrlBase.
                        this._clickTracking = options._clickTracking;

                        // toggle http / https if tag is secure
                        if (this._clickTracking && this.secure) {
                            if (this._clickTracking.trackingUrlBase.indexOf('http://') === 0) {
                                this._clickTracking.trackingUrlBase = this._clickTracking.trackingUrlBase.replace('http://', 'https://');
                            }
                        }

                        // Form ad exchange URL
                        // First, get all query Params
                        var self = this;
                        var queryParams = {
                            'pid': self.pid,
                            'type': 'javascript',
                            'form-factor': self.formFactor
                        };
                        // if external properties are passed, add them to queryParams
                        if (this.external) {
                            for (var e in this.external) {
                                if (this.external.hasOwnProperty(e)) {
                                    queryParams[e] = this.external[e];
                                }
                            }
                        }
                        // add keywords to URL if available
                        if (this.keywords) {
                            var keywords = this.parseKeywords(this.keywords);
                            // keywords being null means error has been thrown, so don't append to URL;
                            if (keywords) queryParams['keywords'] = keywords;
                        }

                        if (this.locationId) {
                            queryParams['locationId'] = this.locationId;
                        }

                        // add debug parameter if true, which will tell exchange to send
                        // back additional debugging data along with response.
                        if (this.debug) {
                            queryParams['debug'] = true;
                        }

                        // add auctionDataFields to request if present in options
                        if (this.auctionDataFields) {
                            queryParams['auctionDataFields'] = this.auctionDataFields;
                        }

                        // finally, form URL
                        var u = (this.secure ? 'https://' + this.exchange_secure_hostname : 'http://' + this.exchange_hostname);
                        u += this.pub_path;
                        u += '?' + serializeObject(queryParams);
                        this.url = encodeURI(u);

                        // For fixed aspectRatio images. If not specified, will deduce dimensions from rendered h & w of image
                        // element
                        if (options.aspectHeight && options.aspectWidth) {
                            this.native.aspectRatio = {};
                            this.native.aspectRatio.height = options.aspectHeight;
                            this.native.aspectRatio.width = options.aspectWidth;
                            // either landscape or portait
                            this.native.aspectRatio.layout = options.aspectLayout || 'landscape';
                            // factor to multiply aspect ratio H*W by when calling image
                            this.native.aspectRatio.scaleFactor = options.scaleFactor || 500;
                        } else if (options.aspectHeight || options.aspectWidth) {
                            console.warn('To use a fixed aspect ratio, you must provide both `aspectHeight` and `aspectWidth` options.')
                        }
                        // Set to 'true' if goal is to just get raw HTML from tag.
                        // if 'true', will return template HTML from this.main();
                        // NOTE: If set to 'true', main() MUST be called w/ callback function
                        this.lazy = options.lazy || false;
                    };

                    /**
                     * Tiny wrapper to invoke event listeners.
                     *
                     * @param event
                     * @param err
                     * @param arg1
                     * @private
                     */
                    _Loader.prototype._emitEvent = function (event, err, arg1) {
                        if (this.events[event]) {
                            this.events[event](err, arg1);
                        }
                    };

                    /**
                     * Users can pass in keywords to options when instantiating CLoader, so need to
                     * a) determine what type of keyword value has been passed (string or array of strings)
                     * b) catch any parsing errors and warn user without erroring out.
                     */
                    _Loader.prototype.parseKeywords = function (keywords) {
                        var warning = 'Could not parse keywords: ' + keywords +
                            '. Keywords must be an array of strings or comma-separated values string.';
                        var keywordStr;
                        if (keywords) {
                            if (typeof keywords === 'object') {
                                try {
                                    keywordStr = keywords.join(',');
                                } catch (e) {
                                    console.warn(warning);
                                }
                            } else if (typeof keywords === 'string') {
                                keywordStr = keywords;
                            } else {
                                console.warn(warning);
                            }
                        }
                        return keywordStr;
                    };

                    /**
                     * Gets width & height of image required based on `this.native.aspectRatio` spec.
                     *
                     * Currently, this normalizes H & W of aspect ratio based on `aspectRatio.layout`. That is,
                     * it respects `aspectRatio.layout` above all else when determining which dimension is truly
                     * height & which is truly width. So if `aspectRatio.layout` === 'landscape', width will be
                     * the greater of the W:H, and vice-versa for 'portait'.
                     *
                     * Will work for both single native placements & multiPaneNative placements
                     *
                     * @returns {{width: (number|*), height: (number|*)}}
                     */
                    _Loader.prototype.getDimsFromAspectRatio = function () {
                        var self = this;
                        var layout = self.native.aspectRatio.layout;
                        var max = Math.max(self.native.aspectRatio.width, self.native.aspectRatio.height);
                        var min = Math.min(self.native.aspectRatio.width, self.native.aspectRatio.height);
                        var width, height;
                        if (layout === 'landscape') {
                            width = max;
                            height = min;
                        } else if (layout === 'portait') {
                            width = min;
                            height = max;
                        } else {
                            console.warn('Accepted aspectLayout values are `landscape` or `portrait`. Cannot deduce ' +
                                'dimensions with layout ' + layout);
                            return;
                        }
                        width = Math.round(self.native.aspectRatio.scaleFactor * width);
                        height = Math.round(self.native.aspectRatio.scaleFactor * height);
                        return {width: width, height: height};
                    };

                    /**
                     * Finds target DOM node on the page where ad tag is to be inserted.
                     *
                     * @param insertBefore {Boolean} if `true`, and dynamic insertion is
                     *  enabled for this loader, will insert an '<ins>' tag before the n-th child
                     *  of the targetId element and return that node. If `false`, will just return
                     *  the n-th node.
                     * @returns {*}
                     */
                    _Loader.prototype.findTargetElement = function (insertBefore) {
                        var self = this;
                        var el;
                        if (this.dynamicInsertion) {
                            // if both targetId & targetChildIndex are present, then
                            // creates an <ins> element as the {{targetChildIndex}}-th child of
                            // the element w/ ID {{targetId}}
                            var parent = document.getElementById(self.targetId);
                            el = parent.children[self.targetChildIndex];
                            if (insertBefore) {
                                var newNode = document.createElement('ins');
                                el = parent.insertBefore(newNode, el);
                            }
                        } else {
                            // otherwise, expects element with the id 'cloader-{ self.pid }' to accompany this tag
                            // & be in the DOM somewhere, and gets that.
                            el = document.getElementById('cloader-' + self.pid);
                        }
                        return el;
                    };

                    /**
                     * Binds template variables in creativeContext to native ad template stored in `placementContext`.
                     *
                     * Populated all variables according to publisher restrictions (where applicable, i.e. `headline` &
                     * `description`) EXCEPT for `secureImageUrl` & `imageUrl`, which get an attribute added to their
                     * element as a flag for the post-render step to come back & attach src attributes to.
                     *
                     * @param template
                     * @param context
                     * @returns {*}
                     */
                    _Loader.prototype.renderNativeTemplate = function (template, context) {
                        var self = this;
                        // brandDisclosure is a derived property (from brandDisclosurePrefix and advertiserName)
                        // so set it to 'true' so it can get handled in the switch statement below
                        context.brandDisclosure = true;
                        var trunctedSuffix = '...';
                        for (var k in context) {
                            if (context.hasOwnProperty(k)) {
                                var value;
                                // handle special cases that need to get truncated / modified according to publisher specs
                                switch (k) {
                                    case 'headline':
                                        value = context.headlineMaxLength ?
                                            context[k].slice(0, context.headlineMaxLength) + trunctedSuffix : context[k];
                                        break;
                                    case 'description':
                                        value = context.descriptionMaxLength ?
                                            context[k].slice(0, context.descriptionMaxLength) + trunctedSuffix : context[k];
                                        break;
                                    case 'brandDisclosure':
                                        value = context.brandDisclosurePrefix + " " + context.advertiserName;
                                        break;
                                    default:
                                        value = context[k];
                                }
                                if (k === 'imageUrl' || k === 'secureImageUrl') {
                                    if (self.lazy) {
                                        // if "lazy", then dimensions are assumed to be passed in already
                                        // under context.nativeDimensions, so go ahead and get the transformURL
                                        var newUrl = _getTransformUrlFromCanonical(context[k],
                                            context.nativeDimensions.width,
                                            context.nativeDimensions.height);
                                        template = _replaceTemplateVar(template, k, newUrl);
                                    } else {
                                        // otherwise, just add an attribute to the element so that the post-render step
                                        // can size it and inject the transform URL.
                                        template = _addAttributeToTemplateVarElement(template, k, IMAGE_ATTR);
                                        template = _replaceTemplateVar(template, k, "");
                                    }
                                } else if (k === 'click_url') {
                                    // have to add attribute to click element so postRender can add click event listener
                                    // to it.
                                    template = _addAttributeToTemplateVarElement(template, k, CLICK_ATTR);
                                    template = _replaceTemplateVar(template, k, value);
                                } else {
                                    template = _replaceTemplateVar(template, k, value);
                                }
                            }
                        }
                        // add separate <img> element for impTracker to beginning of the template
                        if (context.impTracker) {
                            template = template + '<img src="' + context.impTracker + '" height="1" width="1" border="0"  style="display: none;" alt="Advertisement"/>';
                        }
                        // advertisement disclosure is stored in placementContext, not creativeContext
                        if (context.advertisementDisclosure) {
                            template = _replaceTemplateVar(template, 'advertisementDisclosure', context.advertisementDisclosure);
                        }
                        return template;
                    };

                    /**
                     * Creates unified context object to pass to template
                     */
                    _Loader.prototype.getNativeContext = function (placementSpecs, creativeSpecs, exchangeAuctionData, adserverAuctionData) {
                        var context = creativeSpecs;
                        // enumerate all of the properties of placement specs
                        // and add them to context
                        var placementParams = [
                            'brandDisclosurePrefix',
                            'headlineMaxLength',
                            'descriptionMaxLength',
                            'advertisementDisclosure',
                            'minImageHeight'
                        ];
                        placementParams.forEach(function (param) {
                            context[param] = placementSpecs[param];
                        });

                        // finally, add clickTracking & external params
                        context._clickTracking = this._clickTracking;
                        // external subObj
                        context.external = this.external;
                        // set at creative level;
                        context.creativeExternalId = creativeSpecs.creativeExternalId;
                        context.campaignExternalId = creativeSpecs.campaignExternalId;

                        // finally add whatever auction data was passed through
                        context.exchangeAuctionData = exchangeAuctionData;
                        context.auctionDataFields = this.auctionDataFields;
                        context.adserverAuctionData = adserverAuctionData;

                        return context;
                    };

                    /**
                     *
                     * @param lazyCallback only required applicable if this.lazy === true && this.type === 'native'
                     * @returns {*}
                     */
                    _Loader.prototype.doNativeRender = function (lazyCallback) {
                        var self = this;
                        try {
                            var context = self.getNativeContext(
                                self.native.placementSpecs,
                                self.native.creativeSpecs,
                                self.exchangeAuctionData,
                                self.adserverAuctionData);
                            var template = self.native.placementSpecs.template;

                            // fixed dimensions passed to loader
                            var dims;
                            if (self.native.aspectRatio) {
                                dims = self.getDimsFromAspectRatio();
                                context.imageDimensions = dims;
                            }
                            // figure out how ad markup should be injected or returned
                            if (self.lazy) {
                                // otherwise, don't perform all post-render steps and just
                                // do the last template variable injection before passing
                                // HTML as string to callback function
                                if (!dims) {
                                    var err = 'Error: lazy loading requested but no aspectRatio provided. ' +
                                        'Can\'t determine desired image dimensions.';
                                    self._emitEvent('adRendered', err, null);
                                    return lazyCallback(err);
                                }
                                return lazyCallback(null, template, context);
                            } else {
                                var markup = self.renderNativeTemplate(template, context);
                                var el = self.findTargetElement(true);
                                el.innerHTML = markup;
                                // call event hook
                                self._emitEvent('adRendered', null, markup);
                                // finally, do post-render steps
                                _templatePostRender(el, context, dims);
                            }
                        } catch (e) {
                            console.error('Error rendering Cliques native ad: ' + e);
                            if (lazyCallback) lazyCallback(e);
                            self._emitEvent('adRendered', e, null);
                        }
                    };

                    _Loader.prototype.getPanePlaceholderAttribute = function (index) {
                        return 'data-cliques-pane-' + index;
                    };

                    _Loader.prototype.getPanePlaceholder = function (index) {
                        return '<ins ' + this.getPanePlaceholderAttribute(index) + '></ins>';
                    };

                    /**
                     * Renders a single pane of a multiPaneNative placement
                     *
                     * @param lazyCallback only required applicable if this.lazy === true && this.type === 'native'
                     * @param index
                     * @returns {*}
                     */
                    _Loader.prototype.doMultiPaneNativeRender = function (index, lazyCallback) {
                        var self = this;
                        try {
                            var context = self.getNativeContext(
                                self.multiPaneNative.placementSpecs.pane,
                                self.multiPaneNative.creativeSpecs[index],
                                self.exchangeAuctionData[index],
                                self.adserverAuctionData[index]);
                            var template = self.multiPaneNative.placementSpecs.pane.template;

                            // fixed dimensions passed to loader
                            var dims;
                            if (self.native.aspectRatio) {
                                dims = self.getDimsFromAspectRatio();
                                context.imageDimensions = dims;
                            }
                            // figure out how ad markup should be injected or returned
                            if (self.lazy) {
                                // otherwise, don't perform all post-render steps and just
                                // do the last template variable injection before passing
                                // HTML as string to callback function
                                if (!dims) {
                                    var err = 'Error: lazy loading requested but no aspectRatio provided. ' +
                                        'Can\'t determine desired image dimensions.';
                                    self._emitEvent('adRendered', err, null);
                                    return lazyCallback(err);
                                }
                                return lazyCallback(null, template, context);
                            } else {
                                // now render template
                                var markup = self.renderNativeTemplate(template, context);
                                // finally, replace placeholder <ins> tag with template and perform post-render
                                // get parent of target just in case target has been unwrapped and template wrapper contains
                                // multiple root nodes, in which case selecting just the target index child will not necessarily
                                // return the target node.
                                var parent = self.findTargetElement(false).parentElement;
                                var placeholder = _findChildrenWithAttribute(parent, self.getPanePlaceholderAttribute(index))[0];
                                placeholder.innerHTML = markup;
                                // call event hook
                                self._emitEvent('adRendered', null, markup);
                                // finally, do post-render steps
                                _templatePostRender(placeholder, context, dims);
                            }
                        } catch (e) {
                            console.error('Error rendering Cliques multiPaneNative pane: ' + e);
                            if (lazyCallback) lazyCallback(e);
                            self._emitEvent('adRendered', e, null);
                        }
                    };

                    /**
                     * Primary loader function for display placements.
                     * Calls self.url, the ad exchange URL, and kicks of rendering & insertion of display
                     * ad markup, which is returned by the exchange for the winning bidder.
                     *
                     * @param lazyCallback
                     */
                    _Loader.prototype.doDisplayRender = function (lazyCallback) {
                        var self = this;
                        try {
                            var markup = self.display.markup;
                            if (self.lazy) {
                                return lazyCallback(null, markup);
                            } else {
                                var el = self.findTargetElement(true);
                                el.innerHTML = markup;
                                self._emitEvent('adRendered', null, markup);
                                _replaceScripts(el);
                            }
                        } catch (e) {
                            console.error('Error rendering Cliques display ad: ' + e);
                            self._emitEvent('adRendered', e);
                            if (lazyCallback) lazyCallback(e);
                        }
                    };

                    /**
                     * Primary loader function for display placements.
                     * Calls self.url, the ad exchange URL, and kicks of rendering & insertion of display
                     * ad markup, which is returned by the exchange for the winning bidder.
                     *
                     * @param lazyCallback
                     */
                    _Loader.prototype.loadDisplay = function (lazyCallback) {
                        var self = this;
                        var xmlHttp = new XMLHttpRequest();
                        xmlHttp.onreadystatechange = function () {
                            if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {
                                self.display.markup = xmlHttp.responseText;
                                // call event hook
                                self._emitEvent('auctionCompleted', null, self.display.markup);
                                self.doDisplayRender(lazyCallback);
                            } else if (xmlHttp.readyState === 4 && xmlHttp.status !== 200) {
                                self._emitEvent('auctionCompleted', 'Response ' + xmlHttp.status + ' received from exchange', null);
                            }
                        };
                        xmlHttp.open("GET", self.url, true); // true for asynchronous
                        xmlHttp.send(null);
                    };

                    /**
                     * Calls the url provided by winning bid's `adm` (adserver URL) parameter
                     * and kicks of template render. Must be called AFTER exchange has been called,
                     * hence the name.
                     *
                     * @param lazyCallback
                     */
                    _Loader.prototype.onNativePubLoad = function (lazyCallback) {
                        var self = this;
                        var impUrl = self.native.placementSpecs.adm + '&form-factor=' + self.formFactor;
                        var xmlHttp = new XMLHttpRequest();
                        xmlHttp.onreadystatechange = function () {
                            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                                var parsed = JSON.parse(xmlHttp.responseText);
                                self.native.creativeSpecs = parsed;
                                self.adserverAuctionData = parsed.adserverAuctionData;
                                self._emitEvent('adMarkupLoaded', null, self.native.creativeSpecs);
                                self.doNativeRender(lazyCallback);
                            } else if (xmlHttp.readyState == 4 && xmlHttp.status != 200) {
                                self._emitEvent('adMarkupLoaded', 'Response ' + xmlHttp.status + ' received from exchange', null);
                            }
                        };
                        xmlHttp.open("GET", impUrl, true); // true for asynchronous
                        xmlHttp.send(null);
                    };

                    /**
                     * Primary loader function for native placement types. Kicks off
                     * cascade of AJAX calls, first to exchange, then to adserver,
                     * and finally renders templates.
                     *
                     * @param lazyCallback optional callback function to be invoked when ad is all loaded up. Takes
                     *  (err, template, context) as args.
                     */
                    _Loader.prototype.loadNative = function (lazyCallback) {
                        var self = this;
                        var xmlHttp = new XMLHttpRequest();
                        xmlHttp.onreadystatechange = function () {
                            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                                var responseJson = JSON.parse(xmlHttp.responseText);
                                if (self.debug) {
                                    self.debugData = responseJson.debug;
                                }
                                if (!responseJson.default) {
                                    self.native.placementSpecs = responseJson;

                                    // store exchangeAuctionData as well
                                    self.exchangeAuctionData = responseJson.exchangeAuctionData;

                                    if (self.native.placementSpecs.test) {
                                        self.native.creativeSpecs = self.native.placementSpecs; // just for testing
                                        self.doNativeRender(lazyCallback);
                                    } else {
                                        self.onNativePubLoad(lazyCallback);
                                    }
                                } else {
                                    if (lazyCallback) {
                                        return lazyCallback(null, null, null);
                                    }
                                }
                                // call event hook
                                self._emitEvent('auctionCompleted', null, responseJson);
                            } else if (xmlHttp.readyState == 4 && xmlHttp.status != 200) {
                                self._emitEvent('auctionCompleted', 'Response ' + xmlHttp.status + ' received from exchange', null);
                            }
                        };
                        xmlHttp.open("GET", self.url, true); // true for asynchronous
                        xmlHttp.send(null);
                    };

                    /**
                     * Renders & inserts the multiPaneNative placement wrapper HTML template
                     * into the DOM. Done before individual panes are loaded so that they
                     * can be inserted as their ad calls resolve, rather than all at once.
                     */
                    _Loader.prototype.renderMultiPaneWrapper = function () {
                        var self = this;
                        try {
                            var template = self.multiPaneNative.placementSpecs.wrapper.template;
                            // create placeholder ins tags
                            var panes = '';
                            for (var i = 0; i < self.multiPaneNative.placementSpecs.count; i++) {
                                panes += self.getPanePlaceholder(i);
                            }
                            // add custom attribute for screenshot crawler
                            // sort of a hack for now, will not work if panes template variable is changed
                            var re = /<(.*?)>/;
                            // just add attribute to first DOM tag found.
                            template = template.replace(re, '<$1 data-cliques-multi-pane-native>');
                            // populate template variable
                            template = _replaceTemplateVar(template, 'panes', panes);
                            var el = self.findTargetElement(true);
                            el.innerHTML = template;
                            // if dynamic insertion is set, unwrap template from parent <ins> tag
                            if (this.dynamicInsertion) {
                                // now unwrap template <ins>
                                var parent = el.parentElement;
                                var childrenLength = el.children.length;
                                for (var j = 0; j < childrenLength; j++) {
                                    // node.insertBefore pops the element from the children array,
                                    // so just push the 0th element for each j
                                    parent.insertBefore(el.children[0], el);
                                }
                                parent.removeChild(el);
                            }
                            self._emitEvent('adRendered', null, template);
                        } catch (e) {
                            console.error('Error rendering Cliques multiPaneNative wrapper template: ' + e);
                            self._emitEvent('adRendered', e, null);
                        }
                    };

                    /**
                     * Calls the urls provided by winning bid's `adms` array of adserver URLs,
                     * and kicks off parallel template renders. Must be called AFTER exchange has been called,
                     * hence the name.
                     *
                     * @param lazyCallback
                     */
                    _Loader.prototype.onMultiPaneNativePubLoad = function (lazyCallback) {
                        var self = this;
                        // write the wrapper template to the DOM
                        self.renderMultiPaneWrapper();
                        var count = self.multiPaneNative.placementSpecs.count;
                        // then loop over ad-server URL's passed back by each winning bid and create Ajax call
                        // for each one.
                        self.multiPaneNative.creativeSpecs = new Array(count);
                        self.adserverAuctionData = new Array(count);
                        var requests = new Array(count);
                        for (var i = 0; i < self.multiPaneNative.placementSpecs.count; i++) {
                            var adm = self.multiPaneNative.placementSpecs.adms[i];
                            var impUrl = adm.replace('${FORM-FACTOR}', self.formFactor);
                            requests[i] = new XMLHttpRequest();
                            var getCallback = function (index) {
                                return function () {
                                    if (requests[index].readyState === 4 && requests[index].status === 200) {
                                        var parsed = JSON.parse(requests[index].responseText);

                                        // add pane's creative specs to creative specs array
                                        self.multiPaneNative.creativeSpecs[index] = parsed;
                                        self.multiPaneNative.creativeSpecs[index].index = index;

                                        // now add any auctionData passed back by adserver
                                        self.adserverAuctionData[index] = parsed.adserverAuctionData;

                                        // call event hook first
                                        self._emitEvent('adMarkupLoaded', null, self.multiPaneNative.creativeSpecs[index]);

                                        // now do the render
                                        self.doMultiPaneNativeRender(index, lazyCallback);
                                    } else if (requests[index].readyState === 4 && requests[index].status !== 200) {
                                        self._emitEvent('adMarkupLoaded', 'Response ' + requests[index].status + ' received from exchange', null);
                                    }
                                }
                            };
                            requests[i].onreadystatechange = getCallback(i);
                            requests[i].open("GET", impUrl, true); // true for asynchronous
                            requests[i].send(null);
                        }
                    };

                    /**
                     * Primary loader function for multiPaneNative placement types. Kicks off
                     * cascade of AJAX calls, first to exchange, then to adserver for each creative,
                     * and finally renders templates in a loop.
                     *
                     * @param lazyCallback optional callback function to be invoked when ad is all loaded up. Takes
                     *  (err, template, context) as args.
                     */
                    _Loader.prototype.loadMultiPaneNative = function (lazyCallback) {
                        var self = this;
                        var xmlHttp = new XMLHttpRequest();
                        xmlHttp.onreadystatechange = function () {
                            if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {
                                var responseJson = JSON.parse(xmlHttp.responseText);
                                if (self.debug) {
                                    self.debugData = responseJson.debug;
                                }
                                if (!responseJson.default) {
                                    self.multiPaneNative.placementSpecs = responseJson;

                                    // store exchangeAuctionData as well
                                    self.exchangeAuctionData = responseJson.exchangeAuctionData;

                                    if (!self.multiPaneNative.placementSpecs) {
                                        if (lazyCallback) return lazyCallback(null, null, null);
                                        return;
                                    }
                                    if (self.multiPaneNative.placementSpecs.test) {
                                        // just for testing, render templates with test creative data passed by exchange
                                        self.multiPaneNative.creativeSpecs = self.multiPaneNative.placementSpecs.creativeSpecs;
                                        self.renderMultiPaneWrapper();
                                        for (var i = 0; i < self.multiPaneNative.placementSpecs.count; i++) {
                                            self._emitEvent('adMarkupLoaded', null, self.multiPaneNative.creativeSpecs[i]);
                                            self.doMultiPaneNativeRender(i, lazyCallback);
                                        }
                                    } else {
                                        self.onMultiPaneNativePubLoad(lazyCallback);
                                    }
                                } else {
                                    if (lazyCallback) {
                                        return lazyCallback(null, null, null);
                                    }
                                }
                                // call event hook
                                self._emitEvent('auctionCompleted', null, responseJson);
                            } else if (xmlHttp.readyState === 4 && xmlHttp.status !== 200) {
                                self._emitEvent('auctionCompleted', 'Response ' + xmlHttp.status + ' received from exchange', null);
                            }
                        };
                        xmlHttp.open("GET", self.url, true); // true for asynchronous
                        xmlHttp.send(null);
                    };

                    /************************************/
                    /*********** EVENT HOOKS ************/
                    /************************************/

                    /**
                     * Called after response is received from ad exchange server.
                     *
                     * - `auctionCompleted`: Called after response is received from ad exchange server.
                     *  - `callback` takes `(err, response)`. If placement is 'native' or 'multiPaneNative', response will be
                     *      the response JSON, otherwise will be the response text as a string
                     * - `adMarkupLoaded`: Called after response is received from ad server for specific creativegroup endpoint.
                     *      NOTE: Will NOT get called when placement.type == 'display', since display ads are all loaded
                     *      via iFrame which is returned from the exchange server, rather than via Ajax call to the ad-server.
                     *  - `callback` takes `(err, response)`. Response is response JSON with the ad markup.
                     * - `adRendered`: Called after individual ad template is rendered. For multiPaneNative ads, will
                     *      be called multiple times: once for the wrapper template, and once for each inividual pane,
                     *      as they are all rendered independently.
                     *  - `callback` takes `(err, markup)`, markup being the rendered string of ad HTML.
                     */
                    _Loader.prototype.on = function (event, callback) {
                        this.events[event] = callback;
                    };

                    /**
                     * Initiates the process of submitting a Cliques impression request
                     * to the exchange for a placement. Determines what type of placement
                     * object was instantiated with (`placement.type`) and calls appropriate
                     * loader function for that type.
                     *
                     * @param lazyCallback optional callback function to be invoked when ad is all loaded up. Takes
                     *  (err, template, context) as args. NOTE: For display ads, there is no `template` and `context`, just
                     *  markup, so second arg is `markup` and third arg is `null`.
                     */
                    _Loader.prototype.main = function (lazyCallback) {
                        var self = this;
                        switch (this.type) {
                            case 'native':
                                self.loadNative(lazyCallback);
                                break;
                            case 'multiPaneNative':
                                self.loadMultiPaneNative(lazyCallback);
                                break;
                            default:
                                self.loadDisplay(lazyCallback);
                        }
                    };

                    return {
                        init: function (options) {
                            return new _Loader(options);
                        },
                        _getServiceBaseURL: function (options, configString) {
                            var adserviceBaseUrls = JSON.parse(configString);
                            return options.external.staging ? adserviceBaseUrls["staging"] : adserviceBaseUrls["production"];
                        },
                        smarterTravelFactory: function (options, callback) {
                            var self = this;
                            options.external = options.external || {};
                            // first grab options and add click private tracking sub-obj
                            options._clickTracking = {
                                // base click URL to hit. Will serialize options.external & append as query params
                                trackingUrlBase: self._getServiceBaseURL(options, '{"production":"https://r.bookingbuddy.com/t","staging":"https://rstg-origin.bookingbuddy.com"}'),
                                // query parameter key to map creative.externalId to
                                campaignExternalIdKey: 'ad_id'
                            };
                            if (!options.external.hasOwnProperty('test')) {
                                options.external.test = 'true'
                            }
                            // SmarterAds async flag to indicate whether to wrap in event listener
                            // or retrieve search ID's from SmarterAds API service
                            if (window.smarter && window.smarter.nativeActive) {
                                return this._sdkFactory(options, callback);
                            } else {
                                return this._adServiceFactory(options, callback);
                            }
                        },
                        _sdkFactory: function (options, callback) {
                            var self = this;
                            // register handler w/ SmarterAds SDK native ads promise that executes callback w/ new CLoader.
                            window.smarter('wait', {
                                key: 'nativeAdDataDeferrer', handler: function (data) {
                                    // first check to see whether PHG url or STM click URL should be used
                                    if (data.phgCamrefId) {
                                        var phgUrl = self._getServiceBaseURL(options, '{"production":"http://prf.hn/click/","staging":"http://prf.hn/click/"}');
                                        options._clickTracking.trackingUrlBase = phgUrl + 'camref:' + data.phgCamrefId + '/adref:'
                                            + data.phgAdrefId + '/destination:' + options._clickTracking.trackingUrlBase;
                                    }
                                    // pass locationID for targeting purposes
                                    var locationId = data.destinationId || '191';
                                    options.locationId = locationId;
                                    // now set external params, to be passed straight through to
                                    // click URL
                                    options.external.imp_id = data.searchId;
                                    options.external.scoring_destination = locationId;
                                    options.external.location2 = 'g' + locationId;
                                    // try to get scoring scheme from searchRedirectParams from first ad in array.
                                    // All ads should have identical scoring schemes.
                                    if (data.ads && data.ads.length > 0) {
                                        options.external.scoring_scheme = data.ads[0].searchRedirectParams.scoring_scheme;
                                    }
                                    callback(null, new _Loader(options));
                                }
                            });
                        },
                        _adServiceFactory: function (options, callback) {
                            var adserviceParams = {
                                key: '4ad299ca-6d16-403f-b02c-f2b28dbc970c',
                                placement: 'native ads',
                                scheme_id: '271a8989-c1af-4174-84f3-04ef4e4c7392',
                                test: options.external.test
                            };
                            var adserviceBaseUrl = this._getServiceBaseURL(options, '{"production":"https://a.smartertravel.com/a/search/hotel","staging":"https://a-stg.smartertravel.com"}');
                            var locationId = options.locationId || '191';
                            adserviceParams.destination = locationId;
                            var adserviceUrl = [adserviceBaseUrl, serializeObject(adserviceParams)].join('?');
                            var xmlHttp = new XMLHttpRequest();
                            xmlHttp.onreadystatechange = function () {
                                if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {
                                    var responseJson = JSON.parse(xmlHttp.responseText);
                                    var success = responseJson.success;
                                    // now build options.external, which ultimately gets passed to click tracking constructor
                                    options.external.imp_id = responseJson.success.searchId;
                                    options.external.scoring_destination = locationId;
                                    options.external.location2 = 'g' + locationId;
                                    // try to get scoring scheme from searchRedirectParams from first ad in array.
                                    // All ads should have identical scoring schemes.
                                    if (success.ads &&
                                        success.ads["native ads"] &&
                                        success.ads["native ads"].length > 0) {
                                        options.external.scoring_scheme = success.ads["native ads"][0]
                                            .searchRedirectParams.scoring_scheme;
                                    }
                                    callback(null, new _Loader(options));
                                } else if (xmlHttp.readyState === 4 && xmlHttp.status !== 200) {
                                    var msg = 'CLoader factory error: Response ' + xmlHttp.status + ' received from ad service.';
                                    var err = new Error(msg);
                                    console.warn(msg);
                                    callback(err, new _Loader(options));
                                }
                            };
                            xmlHttp.open("GET", adserviceUrl, true); // true for asynchronous
                            xmlHttp.send(null);
                        }
                    };
                }());
            script(type='text/javascript').
                CLoader.smarterTravelFactory({
                    pid: "59c17c622f983661db225751",
                    secure: false,
                    type: "multiPaneNative",
                    targetId: "ad2",
                    targetChildIndex: "0",
                    locationId: null,
                    auctionDataFields: 'clickid,impid,clearprice,pid,pubid,cid,campid,advid',
                    external: {
                        test: true,
                        source: "cliques"
                    }
                }, function (err, cloader) {
                    if (err) {
                        return console.error(err);
                    }
                    cloader.main();
                });
                // Initialize Cliques loader
                // var cloader = CLoader.init({
                //     pid: "59382c8cd1632d23144b51aa",
                //     secure: false,
                //     type: "native",
                //     aspectHeight: 2, // 3:2 aspect ratio
                //     aspectWidth: 3, // 3:2 aspect ratio
                //     scaleFactor: 300,
                //     aspectLayout: "landscape",
                //     lazy: true
                // });
                // cloader.main(function (err, template, context) {
                //     // `renderedTemplate` is the HTML as a string of the populated native ad template.
                //     // `err === null` if ad call & rendering is successful (200), or if ad call results in 204 response, i.e.
                //     // no ad to serve. `err` will only be non-null if a JS error is thrown in rendering process.
                //     //
                //     // If ad-response is empty, i.e. no one bought the impression, then `renderedTemplate` will be null,
                //     // as will `err`.
                //     console.log('entered here');
                //     if (err) {
                //         console.error(err);
                //     }
                // });

            script(type='text/javascript').
                var markups;
                var impIds;
                cloader.on('auctionCompleted', function (err, response) {
                    var MODE = 'view';
                    markups = response.count ? new Array(response.count) : [];
                    if (response.count) {
                        for (var i = 0; i < response.count; i++) {
                            markups[i] = false;
                        }
                    }

                    var placementElement = document.getElementById('placement');
                    var placementOptions = {
                        name: "Placement: " + response.debug.placement.name,
                        mode: MODE
                    };
                    var placementEditor = new JSONEditor(placementElement, placementOptions);
                    var placementData = {
                        name: response.debug.placement.name,
                        type: response.debug.placement.type,
                        active: response.debug.placement.active,
                        pane: response.pane,
                        count: response.count,
                        wrapper: response.wrapper
                    };
                    placementEditor.set(placementData);
                    var bidRequestElement = document.getElementById('bidRequest');
                    var bidRequestOptions = {
                        name: "Bid Request",
                        mode: MODE
                    };
                    var bidRequestEditor = new JSONEditor(bidRequestElement, bidRequestOptions);
                    bidRequestEditor.set(response.debug.bidRequest);

                    // get winning bids & map to array in order of impid
                    var winningBids = [];
                    if (response.debug.winningBid) {
                        impIds = Object.keys(response.debug.winningBid);
                        if (impIds.length > 1) {
                            impIds.sort();
                        }
                        impIds.forEach(function (id) {
                            if (response.debug.winningBid.hasOwnProperty(id)) {
                                winningBids.push(response.debug.winningBid[id]);
                            }
                        });
                        var winningBidElement = document.getElementById('winningBid');
                        var winningBidOptions = {
                            name: "Winning Bid(s)",
                            mode: MODE
                        };
                        var winningBidEditor = new JSONEditor(winningBidElement, winningBidOptions);
                        winningBidEditor.set(winningBids);
                    }
                });

                cloader.on('adMarkupLoaded', function (err, response) {
                    var MODE = 'view';
                    var markupElement = document.getElementById('markup');
                    var markupOptions = {
                        name: "Winning bid ad markup",
                        mode: MODE
                    };
                    if (response.index !== null && response.index != undefined) {
                        markups[response.index] = response;
                        markups[response.index].impid = impIds[response.index];
                        if (markups.every(function (el) {
                                return el;
                            })) {
                            var markupEditor = new JSONEditor(markupElement, markupOptions);
                            markupEditor.set(markups);
                        }
                    } else {
                        markups[0] = response;
                        markups[0].impid = impIds[0];
                        markupEditor = new JSONEditor(markupElement, markupOptions);
                        markupEditor.set(markups[0]);
                    }
                });

        #container
            h1 Cliques Multi-Pane Native Ad - Test Page
            #ad2
            .colWrapper
                .editorCol
                    h3 Step 1: Get Placement Data & Templates
                    #placement
                .editorCol
                    h3 Step 2: Send OpenRTB Bid Request to Bidders
                    #bidRequest
                .editorCol
                    h3 Step 3: Run Auction for Each Impression
                    #winningBid
                .editorCol
                    h3 Step 4: Get Ad Markup & Render Ad Templates
                    #markup